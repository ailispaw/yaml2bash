PROGRAM := yaml2bash

SRCS := main.c
OBJS := $(SRCS:%.c=%.o)
HDRS := version.h yaml2bash.h

CFLAGS  ?= -std=gnu99 -Wall -Werror -O3
LDFLAGS ?= -s
LIBS    := -lyaml

INSTALL_DIR ?= /usr/bin

ifdef DEBUG
	CFLAGS += -DDEBUG
endif

ifdef STATIC
	LDFLAGS += -static
endif

all: $(PROGRAM)

$(PROGRAM): $(OBJS)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)

%.o: %.c $(HDRS)
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

yaml2bash.h: yaml2bash.bash
	printf "/*\n * It's generated by xxd from yaml2bash.bash, so don't touch this.\n */\n" > $@
	xxd -i $< | sed 's/\([0-9a-f]\)$$/\0, 0x00/' >> $@

install: $(INSTALL_DIR)/$(PROGRAM)

$(INSTALL_DIR)/$(PROGRAM): $(PROGRAM)
	install -D -m 0755 $< $@ 

clean:
	$(RM) $(PROGRAM) $(OBJS) yaml2bash.h

.PHONY: all install clean
